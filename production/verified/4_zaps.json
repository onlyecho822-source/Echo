{
  "metadata": {
    "system": "Echo Phoenix v2.4",
    "purpose": "4-Zap Formal Configuration",
    "invariants_enforced": ["I1", "I2", "I3", "I4"],
    "created": "2026-01-15",
    "deployment_target": "production"
  },
  
  "zaps": [
    {
      "zap_id": "Z1",
      "name": "GitHub â†’ Echo Events",
      "description": "Capture GitHub events and forward to /events endpoint",
      "trigger": {
        "app": "GitHub",
        "event": "New Push",
        "filters": [
          {
            "field": "repository.name",
            "operator": "equals",
            "value": "echo-phoenix"
          },
          {
            "field": "ref",
            "operator": "starts_with",
            "value": "refs/heads/"
          }
        ]
      },
      "actions": [
        {
          "step": 1,
          "action": "HTTP POST",
          "config": {
            "url": "https://{{ECHO_DOMAIN}}/events",
            "method": "POST",
            "headers": {
              "X-API-Key": "{{ECHO_API_KEY}}",
              "Content-Type": "application/json"
            },
            "body": {
              "event_id": "{{trigger.head_commit.id}}",
              "event_type": "github.push",
              "actor": "{{trigger.pusher.name}}",
              "payload": {
                "repository": "{{trigger.repository.full_name}}",
                "branch": "{{trigger.ref}}",
                "commit_message": "{{trigger.head_commit.message}}",
                "author": "{{trigger.head_commit.author.email}}",
                "timestamp": "{{trigger.head_commit.timestamp}}"
              }
            }
          }
        }
      ],
      "error_handling": {
        "retry_on_failure": true,
        "max_retries": 3,
        "retry_delay": 300,
        "alert_on_repeated_failure": true,
        "alert_email": "ops@heroeshealth.com"
      },
      "testing": {
        "test_event": {
          "event_id": "test-github-001",
          "event_type": "github.push",
          "actor": "test-user",
          "payload": {"test": true}
        },
        "expected_response": {
          "status": "processed"
        }
      }
    },
    
    {
      "zap_id": "Z2",
      "name": "Stripe â†’ Echo Events",
      "description": "Capture Stripe webhook events and forward to /events endpoint",
      "trigger": {
        "app": "Stripe",
        "event": "New Event",
        "filters": [
          {
            "field": "type",
            "operator": "in",
            "value": [
              "payment_intent.succeeded",
              "payment_intent.payment_failed",
              "charge.succeeded",
              "charge.refunded",
              "customer.created"
            ]
          }
        ]
      },
      "actions": [
        {
          "step": 1,
          "action": "HTTP POST",
          "config": {
            "url": "https://{{ECHO_DOMAIN}}/events",
            "method": "POST",
            "headers": {
              "X-API-Key": "{{ECHO_API_KEY}}",
              "Content-Type": "application/json"
            },
            "body": {
              "event_id": "{{trigger.id}}",
              "event_type": "stripe.payment",
              "actor": "stripe_webhook",
              "payload": {
                "stripe_event_type": "{{trigger.type}}",
                "object_id": "{{trigger.data.object.id}}",
                "amount": "{{trigger.data.object.amount}}",
                "currency": "{{trigger.data.object.currency}}",
                "customer": "{{trigger.data.object.customer}}",
                "status": "{{trigger.data.object.status}}",
                "created": "{{trigger.created}}"
              }
            }
          }
        }
      ],
      "error_handling": {
        "retry_on_failure": true,
        "max_retries": 5,
        "retry_delay": 60,
        "alert_on_repeated_failure": true,
        "alert_email": "finance@heroeshealth.com"
      },
      "invariant_notes": {
        "I1": "event_id from Stripe is globally unique, ensures exactly-once",
        "I4": "All payment events audited regardless of processing result"
      },
      "testing": {
        "test_event": {
          "event_id": "evt_test_stripe_001",
          "event_type": "stripe.payment",
          "actor": "stripe_webhook",
          "payload": {"amount": 1000, "test": true}
        },
        "expected_response": {
          "status": "processed"
        }
      }
    },
    
    {
      "zap_id": "Z3",
      "name": "Echo â†’ GitHub Issues",
      "description": "Create GitHub issue when invariant violation detected",
      "trigger": {
        "app": "Webhooks by Zapier",
        "event": "Catch Hook",
        "webhook_url": "https://hooks.zapier.com/hooks/catch/{{ZAP_WEBHOOK_ID}}/",
        "notes": "Echo Phoenix calls this webhook on I1-I4 violations"
      },
      "actions": [
        {
          "step": 1,
          "action": "Create GitHub Issue",
          "config": {
            "repository": "{{GITHUB_REPO}}",
            "title": "[INVARIANT VIOLATION] {{trigger.invariant}} - {{trigger.timestamp}}",
            "body": "## Invariant Violation Detected\n\n**Invariant:** {{trigger.invariant}}\n**Event ID:** {{trigger.event_id}}\n**Actor:** {{trigger.actor}}\n**Timestamp:** {{trigger.timestamp}}\n\n### Details\n```json\n{{trigger.details}}\n```\n\n### Recommended Actions\n{{trigger.recommended_actions}}\n\n---\n*Auto-generated by Echo Phoenix Formal System*",
            "labels": ["invariant-violation", "priority-high", "auto-generated"],
            "assignees": ["{{GITHUB_OPS_USER}}"]
          }
        },
        {
          "step": 2,
          "action": "Send Email",
          "config": {
            "to": "ops@heroeshealth.com",
            "subject": "ðŸš¨ INVARIANT VIOLATION: {{trigger.invariant}}",
            "body": "Invariant {{trigger.invariant}} violated. GitHub issue created. Check immediately."
          }
        }
      ],
      "error_handling": {
        "retry_on_failure": true,
        "max_retries": 10,
        "retry_delay": 30,
        "alert_on_repeated_failure": true,
        "critical_path": true
      },
      "invariant_notes": {
        "I4": "Violations are audited before this webhook is called",
        "critical": "This zap must never fail - violations must be surfaced"
      },
      "testing": {
        "test_payload": {
          "invariant": "I1",
          "event_id": "test-violation-001",
          "actor": "test-system",
          "timestamp": "2026-01-15T00:00:00Z",
          "details": {"test": true},
          "recommended_actions": "Review deduplication logic"
        }
      }
    },
    
    {
      "zap_id": "Z4",
      "name": "Google Forms â†’ Echo Control",
      "description": "Allow authorized humans to freeze/unfreeze system via form",
      "trigger": {
        "app": "Google Forms",
        "event": "New Form Response",
        "form_id": "{{CONTROL_FORM_ID}}",
        "filters": [
          {
            "field": "Email",
            "operator": "ends_with",
            "value": "@heroeshealth.com"
          }
        ]
      },
      "actions": [
        {
          "step": 1,
          "action": "Validate Actor",
          "config": {
            "type": "Code (Python)",
            "code": "allowed = ['admin', 'ops', 'security']\nactor = input_data['Actor'].lower()\nif actor not in allowed:\n    raise Exception(f'Actor {actor} not authorized')\noutput = {'actor': actor, 'authorized': True}"
          }
        },
        {
          "step": 2,
          "action": "HTTP POST",
          "config": {
            "url": "https://{{ECHO_DOMAIN}}/control",
            "method": "POST",
            "headers": {
              "X-API-Key": "{{ECHO_API_KEY}}",
              "Content-Type": "application/json"
            },
            "body": {
              "action": "{{trigger.Action}}",
              "actor": "{{step1.actor}}",
              "reason": "{{trigger.Reason}}",
              "throttle_value": "{{trigger.ThrottleValue}}"
            }
          }
        },
        {
          "step": 3,
          "action": "Send Confirmation Email",
          "config": {
            "to": "{{trigger.Email}}",
            "subject": "Echo Control Action Executed: {{trigger.Action}}",
            "body": "Your control action has been executed.\n\nAction: {{trigger.Action}}\nReason: {{trigger.Reason}}\nStatus: {{step2.status}}\nTimestamp: {{step2.timestamp}}"
          }
        }
      ],
      "error_handling": {
        "retry_on_failure": false,
        "alert_on_failure": true,
        "alert_email": "security@heroeshealth.com"
      },
      "security_notes": {
        "I2": "Form email validation + actor verification enforces authority separation",
        "rate_limit": "Google Forms has built-in rate limiting",
        "audit": "All control actions logged via I4"
      },
      "testing": {
        "test_submission": {
          "Email": "test@heroeshealth.com",
          "Actor": "admin",
          "Action": "freeze",
          "Reason": "Testing formal control flow",
          "ThrottleValue": "0.0"
        },
        "expected_result": {
          "status": "SYSTEM_FROZEN"
        }
      }
    }
  ],
  
  "deployment_instructions": {
    "step_1": "Create each Zap in Zapier dashboard using configurations above",
    "step_2": "Replace {{ECHO_DOMAIN}} with actual Fly.io URL (e.g., echo-phoenix.fly.dev)",
    "step_3": "Replace {{ECHO_API_KEY}} with value from: openssl rand -hex 32",
    "step_4": "For Z3: Copy webhook URL after creating, add to Echo Phoenix config",
    "step_5": "For Z4: Create Google Form with fields: Email, Actor, Action, Reason, ThrottleValue",
    "step_6": "Test each Zap with test events before enabling",
    "step_7": "Enable all Zaps simultaneously to maintain invariant coverage"
  },
  
  "verification_checklist": [
    {
      "test": "Send test GitHub push â†’ Verify appears in /events audit trail",
      "invariant": "I1, I4"
    },
    {
      "test": "Send duplicate event_id â†’ Verify rejected with 'already_processed'",
      "invariant": "I1"
    },
    {
      "test": "Submit control form as unauthorized actor â†’ Verify rejection",
      "invariant": "I2"
    },
    {
      "test": "Execute freeze command â†’ Verify subsequent /events return 423",
      "invariant": "I3"
    },
    {
      "test": "Trigger invariant violation â†’ Verify GitHub issue created",
      "invariant": "I4"
    }
  ],
  
  "mathematical_guarantees": {
    "latency": "Google â†’ Zapier â†’ Echo < 2 seconds (p95)",
    "reliability": "Each Zap has 99.9% uptime (Zapier SLA)",
    "idempotency": "Zapier retries use same event_id â†’ I1 maintained",
    "audit_completeness": "All Zap executions logged in Zapier + Echo audit trail"
  }
}
