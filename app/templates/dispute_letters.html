{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>Dispute Letter Generator</h1>
    <p>Generate professional dispute letters with proper legal citations to protect your rights</p>
</div>

<div class="grid">
    <div class="card">
        <h2>Generate Dispute Letter</h2>
        <form id="letterForm">
            <label>Letter Type</label>
            <select name="letter_type" id="letterType" required>
                {% for lt in letter_types %}
                <option value="{{ lt.type }}">{{ lt.name }} - {{ lt.use_for }}</option>
                {% endfor %}
            </select>

            <label>Your Full Name</label>
            <input type="text" name="user_name" required placeholder="John Doe">

            <label>Your Street Address</label>
            <input type="text" name="user_address" required placeholder="123 Main Street">

            <label>City, State, ZIP</label>
            <input type="text" name="user_city_state_zip" required placeholder="New York, NY 10001">

            <label>Target Bureau (for bureau disputes)</label>
            <select name="bureau">
                <option value="Experian">Experian</option>
                <option value="Equifax">Equifax</option>
                <option value="TransUnion">TransUnion</option>
            </select>

            <label>Creditor/Collector Name</label>
            <input type="text" name="creditor_name" placeholder="ABC Collections">

            <label>Account Number</label>
            <input type="text" name="account_number" placeholder="XXXX-XXXX-1234">

            <label>Reason for Dispute</label>
            <textarea name="dispute_reason" rows="3" placeholder="Describe why this information is inaccurate..."></textarea>

            <button type="submit" class="btn">Generate Letter</button>
        </form>
    </div>

    <div class="card">
        <h2>Letter Types Explained</h2>
        <div style="max-height: 500px; overflow-y: auto;">
            {% for lt in letter_types %}
            <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h3 style="font-size: 1rem;">{{ lt.name }}</h3>
                <p style="font-size: 0.9rem; color: #a0a0a0;">Best for: {{ lt.use_for }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="letterResult" style="display: none;">
    <div class="card">
        <h2>Generated Letter</h2>
        <div id="letterInfo"></div>
        <br>
        <h3>Letter Content</h3>
        <pre id="letterContent"></pre>
        <br>
        <button onclick="copyLetter()" class="btn btn-secondary">Copy to Clipboard</button>
        <button onclick="printLetter()" class="btn">Print Letter</button>
    </div>

    <div class="card">
        <h2>Sending Instructions</h2>
        <div id="letterInstructions"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('letterForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);

    try {
        const response = await fetch('/api/generate-letter', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            displayLetter(data.letter);
        } else {
            alert('Error generating letter: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

function displayLetter(letter) {
    document.getElementById('letterResult').style.display = 'block';

    // Letter info
    let infoHtml = `
        <div class="result-box">
            <h3>Letter Type: ${letter.type}</h3>
            ${letter.target_bureau ? '<p>Target Bureau: ' + letter.target_bureau + '</p>' : ''}
            <p>Legal Basis: ${letter.legal_basis?.primary_law || letter.legal_basis?.notes || 'N/A'}</p>
        </div>
    `;

    if (letter.legal_basis?.sections) {
        infoHtml += '<br><h3>Legal Citations</h3><ul style="list-style: none;">';
        letter.legal_basis.sections.forEach(section => {
            infoHtml += `<li><span class="tag tag-blue">${section}</span></li>`;
        });
        infoHtml += '</ul>';
    }

    document.getElementById('letterInfo').innerHTML = infoHtml;

    // Letter content
    document.getElementById('letterContent').textContent = letter.content;

    // Instructions
    let instructHtml = '<ul style="line-height: 2;">';
    if (letter.instructions) {
        letter.instructions.forEach(inst => {
            instructHtml += `<li>${inst}</li>`;
        });
    }
    instructHtml += '</ul>';

    if (letter.warnings) {
        instructHtml += '<br><h3 class="warning">Warnings</h3><ul style="line-height: 2;">';
        letter.warnings.forEach(warn => {
            instructHtml += `<li class="warning">${warn}</li>`;
        });
        instructHtml += '</ul>';
    }

    document.getElementById('letterInstructions').innerHTML = instructHtml;

    // Scroll to result
    document.getElementById('letterResult').scrollIntoView({ behavior: 'smooth' });
}

function copyLetter() {
    const content = document.getElementById('letterContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('Letter copied to clipboard!');
    });
}

function printLetter() {
    const content = document.getElementById('letterContent').textContent;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head><title>Dispute Letter</title></head>
        <body style="font-family: 'Times New Roman', serif; padding: 1in; white-space: pre-wrap;">
${content}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}
