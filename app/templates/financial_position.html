{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>Financial Position Assessment</h1>
    <p>Get a complete picture of your financial health and see where you stand</p>
</div>

<div class="card">
    <h2>Calculate Your Net Worth</h2>
    <form id="netWorthForm">
        <div class="grid">
            <div>
                <h3 style="color: #00ff88; margin-bottom: 1rem;">Assets (What You Own)</h3>

                <label>Cash & Savings</label>
                <input type="number" name="cash_savings" value="0" min="0">

                <label>Checking Accounts</label>
                <input type="number" name="checking_accounts" value="0" min="0">

                <label>Investments (Brokerage)</label>
                <input type="number" name="investments" value="0" min="0">

                <label>Retirement Accounts (401k, IRA)</label>
                <input type="number" name="retirement_accounts" value="0" min="0">

                <label>Real Estate Equity</label>
                <input type="number" name="real_estate_equity" value="0" min="0">

                <label>Vehicle Value</label>
                <input type="number" name="vehicle_value" value="0" min="0">

                <label>Other Assets</label>
                <input type="number" name="other_assets" value="0" min="0">
            </div>

            <div>
                <h3 style="color: #ff4444; margin-bottom: 1rem;">Liabilities (What You Owe)</h3>

                <label>Mortgage Balance</label>
                <input type="number" name="mortgage" value="0" min="0">

                <label>Auto Loans</label>
                <input type="number" name="auto_loans" value="0" min="0">

                <label>Student Loans</label>
                <input type="number" name="student_loans" value="0" min="0">

                <label>Credit Card Debt</label>
                <input type="number" name="credit_card_debt" value="0" min="0">

                <label>Personal Loans</label>
                <input type="number" name="personal_loans" value="0" min="0">

                <label>Other Debt</label>
                <input type="number" name="other_debt" value="0" min="0">
            </div>
        </div>
        <br>
        <button type="submit" class="btn">Calculate Net Worth</button>
    </form>

    <div id="netWorthResult" style="display: none; margin-top: 1.5rem;"></div>
</div>

<div class="card">
    <h2>Calculate Your Wealth Score</h2>
    <form id="wealthScoreForm">
        <div class="grid">
            <div>
                <label>Net Worth ($)</label>
                <input type="number" name="net_worth" required placeholder="100000">

                <label>Monthly Income ($)</label>
                <input type="number" name="monthly_income" required placeholder="5000">

                <label>Your Age</label>
                <input type="number" name="age" min="18" max="100" value="30">

                <label>Savings Rate (%)</label>
                <input type="number" name="savings_rate" min="0" max="100" value="10">

                <label>Debt-to-Income Ratio (%)</label>
                <input type="number" name="debt_to_income" min="0" max="100" value="20">
            </div>

            <div>
                <label>Emergency Fund (Months of Expenses)</label>
                <input type="number" name="emergency_months" min="0" max="24" value="3">

                <label>Credit Score</label>
                <input type="number" name="credit_score" min="300" max="850" value="700">

                <label>&nbsp;</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="has_retirement_accounts" style="width: auto;">
                        Have retirement accounts
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" name="has_investments" style="width: auto;">
                        Have investments
                    </label>
                </div>
            </div>
        </div>
        <br>
        <button type="submit" class="btn btn-secondary">Calculate Wealth Score</button>
    </form>

    <div id="wealthScoreResult" style="display: none; margin-top: 1.5rem;"></div>
</div>

<div class="card">
    <h2>Financial Independence Calculator</h2>
    <form id="fireForm">
        <div class="grid">
            <div>
                <label>Current Savings ($)</label>
                <input type="number" name="current_savings" required placeholder="50000">

                <label>Monthly Savings ($)</label>
                <input type="number" name="monthly_savings" required placeholder="1000">
            </div>
            <div>
                <label>Monthly Expenses ($)</label>
                <input type="number" name="monthly_expenses" required placeholder="3000">

                <label>Expected Return (%)</label>
                <input type="number" name="annual_return" step="0.1" value="7">
            </div>
        </div>
        <br>
        <button type="submit" class="btn">Calculate FIRE Timeline</button>
    </form>

    <div id="fireResult" style="display: none; margin-top: 1.5rem;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Net Worth Calculator
document.getElementById('netWorthForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const response = await fetch('/api/calculate-net-worth', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            displayNetWorth(data.result);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

function displayNetWorth(result) {
    const container = document.getElementById('netWorthResult');
    container.style.display = 'block';

    const netWorthClass = result.net_worth >= 0 ? 'success' : 'danger';

    container.innerHTML = `
        <div class="result-box">
            <div class="grid">
                <div>
                    <h3>Total Assets</h3>
                    <p class="success" style="font-size: 1.5rem;">${formatCurrency(result.total_assets)}</p>
                </div>
                <div>
                    <h3>Total Liabilities</h3>
                    <p class="danger" style="font-size: 1.5rem;">${formatCurrency(result.total_liabilities)}</p>
                </div>
                <div>
                    <h3>Net Worth</h3>
                    <p class="${netWorthClass}" style="font-size: 2rem; font-weight: bold;">${formatCurrency(result.net_worth)}</p>
                </div>
            </div>
            <br>
            <p style="color: #a0a0a0;">Liquid Net Worth: ${formatCurrency(result.liquid_net_worth)}</p>
        </div>
    `;
}

// Wealth Score Calculator
document.getElementById('wealthScoreForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const response = await fetch('/api/calculate-wealth-score', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            displayWealthScore(data.result);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

function displayWealthScore(result) {
    const container = document.getElementById('wealthScoreResult');
    container.style.display = 'block';

    const scoreColor = result.wealth_score >= 65 ? '#00ff88' : result.wealth_score >= 35 ? '#ffd700' : '#ff4444';

    let breakdownHtml = '';
    for (const [key, value] of Object.entries(result.breakdown)) {
        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        breakdownHtml += `
            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                <span>${label}</span>
                <span>${value} pts</span>
            </div>
        `;
    }

    container.innerHTML = `
        <div class="result-box">
            <div style="text-align: center;">
                <h3>Your Wealth Score</h3>
                <p style="font-size: 4rem; font-weight: bold; color: ${scoreColor};">${result.wealth_score}</p>
                <p style="font-size: 1.2rem;">Rating: <span class="highlight">${result.rating}</span></p>
                <p style="color: #a0a0a0;">Trajectory: ${result.trajectory}</p>
                <p style="color: #a0a0a0;">Estimated Percentile: Top ${100 - result.percentile}% for your age</p>
            </div>
        </div>
        <br>
        <h3>Score Breakdown</h3>
        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
            ${breakdownHtml}
        </div>
    `;
}

// FIRE Calculator
document.getElementById('fireForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const response = await fetch('/api/calculate-fire-timeline', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            displayFire(data.result);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

function displayFire(result) {
    const container = document.getElementById('fireResult');
    container.style.display = 'block';

    container.innerHTML = `
        <div class="result-box">
            <h3>Financial Independence Target</h3>
            <p class="highlight" style="font-size: 2rem;">${formatCurrency(result.fire_number)}</p>
            <p style="color: #a0a0a0;">Based on 25x your annual expenses (4% rule)</p>
        </div>
        <br>
        <div class="result-box">
            <h3>Time to Financial Independence</h3>
            <p class="highlight" style="font-size: 2rem;">${result.years_to_fire} years</p>
            <p style="color: #a0a0a0;">${result.target_age || ''}</p>
            ${result.message ? `<p class="success" style="margin-top: 1rem;">${result.message}</p>` : ''}
        </div>
        <br>
        <p style="font-size: 0.9rem; color: #a0a0a0;">
            Tips to accelerate: Increase savings rate, reduce expenses, earn more income, optimize investment returns.
        </p>
    `;
}
</script>
{% endblock %}
