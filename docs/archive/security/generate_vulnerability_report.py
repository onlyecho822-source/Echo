#!/usr/bin/env python3
"""
Vulnerability Report Generator
Combines scan results and generates comprehensive reports
"""

import json
import sys
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Any

class VulnerabilityReportGenerator:
    """Generate comprehensive vulnerability reports"""
    
    def __init__(self):
        self.report = {
            "timestamp": datetime.utcnow().isoformat() + "Z",
            "scans": {},
            "summary": {
                "critical": 0,
                "high": 0,
                "moderate": 0,
                "low": 0,
                "total": 0
            },
            "trends": {},
            "recommendations": []
        }
    
    def add_scan_result(self, scan_name: str, scan_data: Dict[str, Any]):
        """Add a scan result to the report"""
        self.report["scans"][scan_name] = scan_data
        
        # Update summary
        if "summary" in scan_data:
            for severity in ["critical", "high", "moderate", "low"]:
                self.report["summary"][severity] += scan_data["summary"].get(severity, 0)
    
    def calculate_totals(self):
        """Calculate total vulnerabilities"""
        self.report["summary"]["total"] = sum([
            self.report["summary"]["critical"],
            self.report["summary"]["high"],
            self.report["summary"]["moderate"],
            self.report["summary"]["low"]
        ])
    
    def generate_recommendations(self):
        """Generate security recommendations based on vulnerabilities"""
        recommendations = []
        
        if self.report["summary"]["critical"] > 0:
            recommendations.append({
                "priority": "CRITICAL",
                "action": "Immediately patch all critical vulnerabilities",
                "details": f"Found {self.report['summary']['critical']} critical vulnerabilities that require immediate attention"
            })
        
        if self.report["summary"]["high"] > 0:
            recommendations.append({
                "priority": "HIGH",
                "action": "Schedule patching for high-severity vulnerabilities within 7 days",
                "details": f"Found {self.report['summary']['high']} high-severity vulnerabilities"
            })
        
        if self.report["summary"]["moderate"] > 0:
            recommendations.append({
                "priority": "MEDIUM",
                "action": "Plan patching for moderate vulnerabilities within 30 days",
                "details": f"Found {self.report['summary']['moderate']} moderate vulnerabilities"
            })
        
        if self.report["summary"]["total"] == 0:
            recommendations.append({
                "priority": "INFO",
                "action": "No vulnerabilities detected",
                "details": "All scans completed successfully with no known vulnerabilities"
            })
        
        self.report["recommendations"] = recommendations
    
    def generate_html_report(self) -> str:
        """Generate HTML version of the report"""
        html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Universe - Daily Security Report</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }}
        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }}
        .header h1 {{
            margin: 0;
            font-size: 28px;
        }}
        .header p {{
            margin: 5px 0 0 0;
            opacity: 0.9;
        }}
        .summary {{
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }}
        .summary-card {{
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }}
        .summary-card.critical {{
            border-left: 4px solid #dc3545;
        }}
        .summary-card.high {{
            border-left: 4px solid #fd7e14;
        }}
        .summary-card.moderate {{
            border-left: 4px solid #ffc107;
        }}
        .summary-card.low {{
            border-left: 4px solid #17a2b8;
        }}
        .summary-card h3 {{
            margin: 0 0 10px 0;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }}
        .summary-card .number {{
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }}
        .section {{
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        .section h2 {{
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }}
        .vulnerability {{
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ddd;
            background-color: #f9f9f9;
        }}
        .vulnerability.critical {{
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }}
        .vulnerability.high {{
            border-left-color: #fd7e14;
            background-color: #fffbf0;
        }}
        .vulnerability.moderate {{
            border-left-color: #ffc107;
            background-color: #fffef5;
        }}
        .vulnerability.low {{
            border-left-color: #17a2b8;
            background-color: #f0f8fb;
        }}
        .vulnerability h4 {{
            margin: 0 0 5px 0;
            color: #333;
        }}
        .vulnerability p {{
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }}
        .recommendation {{
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            background-color: #f0f8f4;
        }}
        .recommendation.critical {{
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }}
        .recommendation.high {{
            border-left-color: #fd7e14;
            background-color: #fffbf0;
        }}
        .footer {{
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }}
        .badge {{
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }}
        .badge.critical {{
            background-color: #dc3545;
            color: white;
        }}
        .badge.high {{
            background-color: #fd7e14;
            color: white;
        }}
        .badge.moderate {{
            background-color: #ffc107;
            color: #333;
        }}
        .badge.low {{
            background-color: #17a2b8;
            color: white;
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ”’ Echo Universe Security Report</h1>
        <p>Daily vulnerability scan - {self.report['timestamp']}</p>
    </div>
    
    <div class="summary">
        <div class="summary-card critical">
            <h3>Critical</h3>
            <div class="number">{self.report['summary']['critical']}</div>
        </div>
        <div class="summary-card high">
            <h3>High</h3>
            <div class="number">{self.report['summary']['high']}</div>
        </div>
        <div class="summary-card moderate">
            <h3>Moderate</h3>
            <div class="number">{self.report['summary']['moderate']}</div>
        </div>
        <div class="summary-card low">
            <h3>Low</h3>
            <div class="number">{self.report['summary']['low']}</div>
        </div>
    </div>
"""
        
        # Add recommendations
        if self.report["recommendations"]:
            html += '<div class="section"><h2>ðŸ“‹ Recommendations</h2>'
            for rec in self.report["recommendations"]:
                html += f'''
    <div class="recommendation {rec['priority'].lower()}">
        <h4><span class="badge {rec['priority'].lower()}">{rec['priority']}</span> {rec['action']}</h4>
        <p>{rec['details']}</p>
    </div>
'''
            html += '</div>'
        
        # Add scan details
        for scan_name, scan_data in self.report["scans"].items():
            if scan_data.get("summary", {}).get("total", 0) > 0:
                html += f'<div class="section"><h2>ðŸ“Š {scan_name} Results</h2>'
                
                for severity in ["critical", "high", "moderate", "low"]:
                    vulns = scan_data.get("vulnerabilities", {}).get(severity, [])
                    if vulns:
                        html += f'<h3>{severity.capitalize()} ({len(vulns)})</h3>'
                        for vuln in vulns:
                            html += f'''
    <div class="vulnerability {severity}">
        <h4>{vuln.get('package', vuln.get('title', 'Unknown'))}</h4>
        <p><strong>Severity:</strong> {severity.upper()}</p>
        <p><strong>Title:</strong> {vuln.get('title', 'N/A')}</p>
        {f"<p><strong>CVE:</strong> {vuln.get('cve', 'N/A')}</p>" if vuln.get('cve') else ""}
        {f"<p><a href='{vuln.get('url')}' target='_blank'>View Details</a></p>" if vuln.get('url') else ""}
    </div>
'''
                
                html += '</div>'
        
        html += '''
    <div class="footer">
        <p>Echo Universe Security Monitoring System</p>
        <p>Report generated automatically at 8:00 AM EST</p>
    </div>
</body>
</html>
'''
        return html
    
    def generate_text_report(self) -> str:
        """Generate plain text version of the report"""
        text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ECHO UNIVERSE - DAILY SECURITY REPORT                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Generated: {self.report['timestamp']}

VULNERABILITY SUMMARY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Critical:  {self.report['summary']['critical']}
High:      {self.report['summary']['high']}
Moderate:  {self.report['summary']['moderate']}
Low:       {self.report['summary']['low']}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:     {self.report['summary']['total']}

RECOMMENDATIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
        for rec in self.report["recommendations"]:
            text += f"\n[{rec['priority']}] {rec['action']}\n{rec['details']}\n"
        
        text += "\n\nDETAILED SCAN RESULTS\n"
        text += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        
        for scan_name, scan_data in self.report["scans"].items():
            text += f"\n{scan_name}\n"
            text += "=" * len(scan_name) + "\n"
            
            for severity in ["critical", "high", "moderate", "low"]:
                vulns = scan_data.get("vulnerabilities", {}).get(severity, [])
                if vulns:
                    text += f"\n{severity.upper()} ({len(vulns)})\n"
                    text += "-" * (len(severity) + 3) + "\n"
                    for vuln in vulns:
                        text += f"  â€¢ {vuln.get('package', vuln.get('title', 'Unknown'))}\n"
                        if vuln.get('cve'):
                            text += f"    CVE: {vuln['cve']}\n"
        
        text += "\n\n" + "=" * 64 + "\n"
        text += "Report generated by Echo Universe Security Monitoring System\n"
        text += "=" * 64 + "\n"
        
        return text
    
    def get_report_dict(self) -> Dict[str, Any]:
        """Get report as dictionary"""
        return self.report

def main():
    if len(sys.argv) < 2:
        print("Usage: generate_vulnerability_report.py <scan_results_json> [scan_results_json ...]")
        sys.exit(1)
    
    generator = VulnerabilityReportGenerator()
    
    # Load and add all scan results
    for scan_file in sys.argv[1:]:
        try:
            with open(scan_file, 'r') as f:
                scan_data = json.load(f)
                scan_name = Path(scan_file).stem
                generator.add_scan_result(scan_name, scan_data)
        except Exception as e:
            print(f"Error loading {scan_file}: {e}", file=sys.stderr)
    
    generator.calculate_totals()
    generator.generate_recommendations()
    
    # Output JSON report
    print(json.dumps(generator.get_report_dict(), indent=2))

if __name__ == "__main__":
    main()
