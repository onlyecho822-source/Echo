name: Constitutional Coordination Audit

# Constitutional Authority: Article XI-C (Delegated Maintenance)
# Rule Set: /.github/rules/coordination-audit-rules.yaml
# Status: Executive Clerk (proposes, does not decide)

on:
  schedule:
    # Weekly only - reduces autonomic presence, increases deliberation
    - cron: '0 9 * * 1'  # Every Monday at 9:00 AM UTC
  
  workflow_dispatch:
    inputs:
      justification:
        description: 'Human reason for invoking this automation'
        required: true
        default: 'Routine constitutional maintenance - weekly coordination audit'
        type: string

permissions:
  contents: write      # To create branches and PRs
  pull-requests: write # To create and label PRs
  issues: write        # To create issues if needed

jobs:
  constitutional-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diagnostic analysis
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Generate diagnostic report (Article XI compliant)
        id: diagnose
        run: |
          # Create timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          # Generate diagnostic data
          echo "## Constitutional Coordination Audit - $TIMESTAMP" > audit_report.md
          echo "" >> audit_report.md
          
          echo "### Invocation Context" >> audit_report.md
          echo "- **Trigger**: ${{ github.event_name }}" >> audit_report.md
          echo "- **Run ID**: ${{ github.run_id }}" >> audit_report.md
          echo "- **Justification**: ${{ github.event.inputs.justification || 'Scheduled weekly audit' }}" >> audit_report.md
          echo "- **Authority**: Article XI-C (Delegated Maintenance)" >> audit_report.md
          echo "" >> audit_report.md
          
          echo "### Repository Health Metrics" >> audit_report.md
          echo "- **Total Markdown Documents**: $(find . -name '*.md' -not -path './node_modules/*' | wc -l)" >> audit_report.md
          echo "- **Total Python Files**: $(find . -name '*.py' -not -path './node_modules/*' | wc -l)" >> audit_report.md
          echo "- **Total Commits**: $(git rev-list --count HEAD)" >> audit_report.md
          echo "- **Last Commit**: \`$(git log -1 --format='%h - %s (%ar)')\`" >> audit_report.md
          echo "- **Active Branches**: $(git branch -r | wc -l)" >> audit_report.md
          echo "" >> audit_report.md
          
          echo "### Active Project Status" >> audit_report.md
          echo "- **Global Nexus**: $(test -d global-nexus && echo 'âœ… Active' || echo 'âš ï¸ Directory not found')" >> audit_report.md
          echo "- **Sherlock Hub**: $(test -d sherlock-hub && echo 'âœ… Active' || echo 'âš ï¸ Directory not found')" >> audit_report.md
          echo "- **EchoNate Integration**: $(test -f ECHONATE_MANUS_INTEGRATION.md && echo 'âœ… Documented' || echo 'âš ï¸ Missing')" >> audit_report.md
          echo "- **Coordination Master**: $(test -f PROJECT_COORDINATION_MASTER.md && echo 'âœ… Present' || echo 'âš ï¸ Missing')" >> audit_report.md
          echo "" >> audit_report.md
          
          echo "### Recent Activity (Last 7 Days)" >> audit_report.md
          RECENT_COMMITS=$(git log --since="7 days ago" --pretty=format:"- %s (%ar)" | head -20)
          if [ -z "$RECENT_COMMITS" ]; then
            echo "No commits in the last 7 days" >> audit_report.md
          else
            echo "$RECENT_COMMITS" >> audit_report.md
          fi
          echo "" >> audit_report.md
          
          echo "### Untracked Files" >> audit_report.md
          UNTRACKED=$(git status --porcelain | grep '^??' | cut -c4-)
          if [ -z "$UNTRACKED" ]; then
            echo "No untracked files" >> audit_report.md
          else
            echo "\`\`\`" >> audit_report.md
            echo "$UNTRACKED" >> audit_report.md
            echo "\`\`\`" >> audit_report.md
          fi
          echo "" >> audit_report.md
          
          echo "### Constitutional Compliance Check" >> audit_report.md
          echo "- **Branch Protection**: $(gh api repos/${{ github.repository }}/branches/main/protection 2>/dev/null && echo 'âœ… Enabled' || echo 'âš ï¸ Not configured')" >> audit_report.md
          echo "- **CODEOWNERS File**: $(test -f .github/CODEOWNERS && echo 'âœ… Present' || echo 'âš ï¸ Missing')" >> audit_report.md
          echo "- **Rule Set Documentation**: $(test -f .github/rules/coordination-audit-rules.yaml && echo 'âœ… Present' || echo 'âš ï¸ Missing')" >> audit_report.md
          echo "" >> audit_report.md
          
          echo "---" >> audit_report.md
          echo "" >> audit_report.md
          echo "**âˆ‡Î¸ â€” Diagnostic complete. Awaiting human ratification.**" >> audit_report.md
          
          # Display report
          cat audit_report.md
          
          # Create JSON summary for programmatic use
          cat > audit_summary.json <<EOF
          {
            "timestamp": "$TIMESTAMP",
            "run_id": "${{ github.run_id }}",
            "trigger": "${{ github.event_name }}",
            "justification": "${{ github.event.inputs.justification || 'Scheduled weekly audit' }}",
            "metrics": {
              "markdown_files": $(find . -name '*.md' -not -path './node_modules/*' | wc -l),
              "python_files": $(find . -name '*.py' -not -path './node_modules/*' | wc -l),
              "total_commits": $(git rev-list --count HEAD),
              "active_branches": $(git branch -r | wc -l)
            }
          }
          EOF
          
          echo "report_generated=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Update coordination master timestamp
        if: steps.diagnose.outputs.report_generated == 'true'
        run: |
          if [ -f PROJECT_COORDINATION_MASTER.md ]; then
            # Update timestamp with audit trail
            sed -i "s/Last Updated:.*/Last Updated: ${{ steps.diagnose.outputs.timestamp }} (Audit Run: ${{ github.run_id }})/" PROJECT_COORDINATION_MASTER.md
            echo "âœ… Updated PROJECT_COORDINATION_MASTER.md timestamp"
          else
            echo "âš ï¸ PROJECT_COORDINATION_MASTER.md not found - skipping update"
          fi
      
      - name: Append to automation ledger
        if: steps.diagnose.outputs.report_generated == 'true'
        run: |
          # Create ledger directory if it doesn't exist
          mkdir -p ledgers/automation
          
          # Initialize ledger if it doesn't exist
          if [ ! -f ledgers/automation/coordination_log.jsonl ]; then
            echo "[]" > ledgers/automation/coordination_log.jsonl
          fi
          
          # Append audit entry (JSONL format for immutability)
          cat audit_summary.json >> ledgers/automation/coordination_log.jsonl
          echo "" >> ledgers/automation/coordination_log.jsonl
          
          echo "âœ… Appended audit entry to coordination ledger"
      
      - name: Create Pull Request (Human Ratification Required)
        if: steps.diagnose.outputs.report_generated == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(coordination): Constitutional audit update ${{ github.run_id }}
            
            Automated diagnostic proposes updates based on rule set: [Constitution Article XI-C]
            
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Justification: ${{ github.event.inputs.justification || 'Scheduled weekly audit' }}
            
            âˆ‡Î¸ â€” Authority is delegated, human ratification required.
          branch: automated/coordination-audit-${{ github.run_number }}
          delete-branch: true
          title: "âš–ï¸ Constitutional Proposal: Coordination Audit ${{ steps.diagnose.outputs.timestamp }}"
          body: |
            ## âš–ï¸ Automated Constitutional Proposal
            
            This Pull Request is created by an **agent operating under delegated authority** from the Echo Universe Constitution.
            
            ### Governance Context
            - **Trigger**: ${{ github.event_name }}
            - **Human Justification**: `${{ github.event.inputs.justification || 'Scheduled weekly audit' }}`
            - **Authority Source**: Article XI-C (Delegated Maintenance)
            - **Rule Set**: `/.github/rules/coordination-audit-rules.yaml`
            - **Run ID**: ${{ github.run_id }}
            - **Audit Timestamp**: ${{ steps.diagnose.outputs.timestamp }}
            
            ### Proposed Changes
            This PR proposes to update:
            1. **Timestamp** in `PROJECT_COORDINATION_MASTER.md`
            2. **Audit entry** appended to `ledgers/automation/coordination_log.jsonl`
            3. **Diagnostic report** saved as `audit_report.md`
            
            ### Required Human Action
            1. **Review** the diagnostic data below
            2. **Merge** to ratify these changes as legitimate
            3. **Close** to reject the automated proposal
            
            > **Constitutional Note**: Merging this PR constitutes human ratification of delegated automation. The automation did not act autonomouslyâ€”it proposed, and you decide.
            
            ### Diagnostic Report
            <details>
            <summary>ðŸ“Š Full Diagnostic Report (Click to expand)</summary>
            
            $(cat audit_report.md)
            
            </details>
            
            ### Audit Trail
            - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Branch**: `automated/coordination-audit-${{ github.run_number }}`
            - **Commits**: View the "Files changed" tab above
            
            ---
            
            **âˆ‡Î¸ â€” Proposal generated, sovereignty preserved. Human judgment required.**
          labels: |
            automated-proposal
            requires-human-ratification
            constitutional-delegation
            coordination
          assignees: ${{ github.repository_owner }}
