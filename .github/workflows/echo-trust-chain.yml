name: Echo Trust Chain Verification
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  verify-chain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history
          
      - name: Verify Commit Chain
        run: |
          echo "ðŸ” Verifying Cryptographic Trust Chain"
          echo ""
          
          # Get last 10 commits
          git log --oneline -10 > commits.txt
          
          echo "ðŸ“œ Recent Commits:"
          cat commits.txt
          echo ""
          
          # Verify each commit has valid parent
          echo "ðŸ”— Verifying Chain Integrity:"
          git log --pretty=format:"%H %P" -10 | while read commit parents; do
            if [ -n "$parents" ]; then
              for parent in $parents; do
                if git cat-file -e $parent 2>/dev/null; then
                  echo "  âœ“ $commit â†’ $parent (valid)"
                else
                  echo "  âœ— $commit â†’ $parent (BROKEN)"
                  exit 1
                fi
              done
            else
              echo "  â­ $commit (root commit)"
            fi
          done
          
      - name: Check Commit Signatures
        run: |
          echo ""
          echo "ðŸ“ Checking Commit Signatures:"
          git log --show-signature -5 2>&1 | grep -E "(commit|gpg:|Good signature|No signature)" || echo "  â„¹ï¸  No GPG signatures found (optional)"
          
      - name: Verify Repository Integrity
        run: |
          echo ""
          echo "ðŸ” Repository Integrity Check:"
          git fsck --full 2>&1 | head -20
          echo "  âœ… Repository integrity verified"
          
      - name: Generate Trust Report
        run: |
          echo ""
          echo "ðŸ“Š Trust Chain Report:"
          echo "  Repository: ${{ github.repository }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Latest commit: $(git rev-parse HEAD)"
          echo "  Total commits: $(git rev-list --count HEAD)"
          echo "  Chain verified: âœ…"
          echo "  Timestamp: $(date -Iseconds)"
